<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SpotiFeel</title>

    <!-- Bootstrap Core CSS -->
    <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="../vendor/metisMenu/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">

    <!-- Morris Charts CSS -->
    <link href="../vendor/morrisjs/morris.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/png" href="media/favicon.png"/>

    <!-- For Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>

    <!-- For jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>

    <!-- Genres object element -->
    <script src="allgenres.js"></script>

    <!-- NRC Word-Emotion Association Lexicon object element -->
    <script src="nrc-emotion-lexicon-v0.92.js"></script>

    <!-- Require.js -->
    <script src="require.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<style>

#tracklist {
    max-height: 70vh;
    overflow-y: scroll;
}

</style>

<body>

    <div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">SpotiFeel</a>
            </div>
            <!-- /.navbar-header -->

            <ul class="nav navbar-top-links navbar-right">
                <li class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#aboutModal"><i class="fa fa-info-circle fa-fw"></i> About</a>
                </li>
                <!-- /.nav-item -->
                <li class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#helpModal"><i class="fa fa-question-circle fa-fw"></i> Help</a>
                </li>
                <!-- /.nav-item -->
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-user fa-fw"></i> Profile <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a data-toggle="modal" data-target="#profileModal"><i class="fa fa-user fa-fw"></i> User Profile</a>
                        </li>
                        <li><a data-toggle="modal" data-target="#settingsModal"><i class="fa fa-gear fa-fw"></i> Settings</a>
                        </li>
                        <li class="divider"></li>
                        <li><a href="login.html"><i class="fa fa-sign-out fa-fw"></i> Logout</a>
                        </li>
                    </ul>
                    <!-- /.dropdown-user -->
                </li>
                <!-- /.dropdown -->
            </ul>
            <!-- /.navbar-top-links -->

            <div class="navbar-default sidebar" role="navigation">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                        <li class="sidebar-search">
                            <div class="input-group custom-search-form">
                                <input type="text" class="form-control" placeholder="Search...">
                                <span class="input-group-btn">
                                <button class="btn btn-default" type="button">
                                    <i class="fa fa-search"></i>
                                </button>
                            </span>
                            </div>
                            <!-- /input-group -->
                        </li>
                        <li>
                            <a data-toggle="modal" data-target="#playlistModal"><i class="fa fa-th-list fa-fw"></i> Select a Playlist</a>
                        </li>
                        <li>
                            <a onclick="getRecentTracks()"><i class="fa fa-dashboard fa-fw"></i> Most Recent Tracks</a>
                        </li>
                        <li>
                            <a><i class="fa fa-bar-chart-o fa-fw"></i> My Top Tracks<span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a onclick="getTopTracks('short_term')">Short-Term</a>
                                </li>
                                <li>
                                    <a onclick="getTopTracks('medium_term')">Medium-Term</a>
                                </li>
                                <li>
                                    <a onclick="getTopTracks('long_term')">Long-Term</a>
                                </li>
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>

        <!-- Modals -->
        <!-- About Modal -->
        <div class="modal fade" id="aboutModal" role="dialog">
            <div class="modal-dialog">
            
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">About SpotiFeel</h4>
                </div>
                <div class="modal-body">
                    <p>Some text about SpotiFeel</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
                </div>
            </div>
            
            </div>
        </div>
    
        <!-- Help Modal -->
        <div class="modal fade" id="helpModal" role="dialog">
            <div class="modal-dialog">
            
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Help</h4>
                </div>
                <div class="modal-body">
                    <p>Some text.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
                </div>
            </div>
            
            </div>
        </div>
    
        <!-- Profile Modal -->
        <div class="modal fade" id="profileModal" role="dialog">
            <div class="modal-dialog">
            
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Modal Header</h4>
                </div>
                <div class="modal-body">
                    <div id="user-profile"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
                </div>
            </div>
            
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal fade" id="settingsModal" role="dialog">
            <div class="modal-dialog">
            
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Modal Header</h4>
                </div>
                <div class="modal-body">
                    <div id="oauth"></div>
                    <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>                
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
                </div>
            </div>
            
            </div>
        </div>

        <!-- Playlist Modal -->
        <div class="modal fade" id="playlistModal" role="dialog">
            <div class="modal-dialog">
            
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Select a Playlist</h4>
                </div>
                <div class="modal-body">
                    <div id="playlist-table"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
                </div>
            </div>
            
            </div>
        </div>

        <!-- Page Content -->
        <div id="page-wrapper">
            <div class="row">
                <div class="col-sm-8">
                    <div id="chart-container">
                        <canvas id="bubbleChart" height="315" width="400"></canvas>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div id="tracks">
                        <h2>Tracks info</h2>
                        <dl id="track-total"></dl>
                        <ul class="list-group" id="tracklist"></ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- Instantiate variables -->
    <script>
        var topSongsLong;
        var topSongsMedium;
        var topSongsShort;
        var topArtistsLong;
        var topArtistsMedium;
        var topArtistsShort;
        var topTrackFlag = false;
        var genreStringArray = ["p", "h", "e", "me", "ro", "rb", "co", "j", "w", "cl", "mi", "u"];
        var genreLongStringArray = ["pop", "hip-hop", "electronic/dance", "metal", "rock", "r&b", "country/folk", "jazz", "world", "classical", "misc", "unknown"]
        var genreColorArray =  ["rgba(242, 84, 91, 0.7)", // pop
                                "rgba(60, 145, 230, 0.7)", // hip hop
                                "rgba(206, 236, 151, 0.7)", // electronic
                                "rgba(53, 53, 53, 0.7)", // metal
                                "rgba(55, 147, 146, 0.7)", // rock
                                "rgba(224, 186, 215, 0.7)", // rnb
                                "rgba(250, 131, 52, 0.7)", // country/folk
                                "rgba(78, 89, 140, 0.7)", // jazz
                                "rgba(116, 79, 198, 0.7)", // world
                                "rgba(141, 91, 76, 0.7)", // classical
                                "rgba(192, 195, 206, 0.7)", // misc
                                "rgba(255, 255, 255, 0.7)"] // unknown
    </script>

    <script>
        var canvas = document.getElementById("bubbleChart");
        var options = {
            tooltips: {
                callbacks: {
                    label: function(tooltipItem, data) {
                        var song = data.songs[tooltipItem.datasetIndex][tooltipItem.index];
                        var artist = data.artists[tooltipItem.datasetIndex][tooltipItem.index];
                        rLabel = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index].r;
                        return "\"" + song + "\" - " + artist + ': (' + tooltipItem.xLabel + ', ' + tooltipItem.yLabel + ', ' + parseFloat(rLabel.toFixed(2)).toString() + ')';
                    }
                }
            },
            scales: {
                xAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: 'Valence',
                        fontSize: 14
                    },
                    ticks: {
                        beginAtZero: true,
                        min: -10,
                        max: 10
                    }
                }],
                yAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: 'Energy',
                        fontSize: 14
                    },
                    ticks: {
                        beginAtZero: true,
                        min: -10,
                        max: 10
                    }
                }]
            }
        };
        var bubbleChart = new Chart(canvas, {
            type: 'bubble',
            options: options
        });
    </script>

    <script id="user-profile-template" type="text/x-handlebars-template">
    <h1>Logged in as {{display_name}}</h1>
    <div class="media">
        <div class="pull-left">
        <img class="media-object" width="150" src="{{images.0.url}}" />
        </div>
        <div class="media-body">
        <dl class="dl-horizontal">
            <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
            <dt>Id</dt><dd>{{id}}</dd>
            <dt>Email</dt><dd>{{email}}</dd>
            <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
            <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
            <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
            <dt>Country</dt><dd>{{country}}</dd>
            <dt>Followers</dt><dd>{{followers.total}}</dd>
        </dl>
        </div>
    </div>
    </script>

    <script id="oauth-template" type="text/x-handlebars-template">
    <h2>oAuth info</h2>
    <dl class="dl-horizontal">
        <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
        <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
    </dl>
    </script>

    <script id="playlist-template" type="text/x-handlebars-template">
    <div class="list-group">
        {{#each}}
        <a class="list-group-item list-group-item-action" onclick="getTracks('{{{this.tracks.href}}}')">{{{this.name}}}</li>
        {{/each}}
    </div>
    </script>

    <script id="tracks-template" type="text/x-handlebars-template">
    <h2>Tracks info</h2>
    <dl class="dl-horizontal">
        <dt>Number of tracks</dt><dd>{{total}}</dd>
        <ul class="list-group" id="tracklist">
            {{#printTracks items}}
            {{items}}
            {{/printTracks}}
        </ul>
    </dl>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
    (function() {

        /**
        * Obtains parameters from the hash of the URL
        * @return Object
        */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while ( e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

        var oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');

        var playlistSource = document.getElementById('playlist-template').innerHTML,
            playlistTemplate = Handlebars.compile(playlistSource),
            playlistPlaceholder = document.getElementById('playlist-table');

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        if (error) {
            alert('There was an error during the authentication');
        } else {
        if (access_token) {
            // render oauth info
            oauthPlaceholder.innerHTML = oauthTemplate({
            access_token: access_token,
            refresh_token: refresh_token
            });

            $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                    userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                    $('#login').hide();
                    $('#loggedin').show();
                }
            });

            $.ajax({
                url: 'https://api.spotify.com/v1/me/playlists',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                    //playlistPlaceholder.innerHTML = playlistTemplate(response);

                    // Create list-group for Playlist Modal
                    var listGroup = document.createElement("div");

                    // Add playlists to Playlist Modal
                    for (var i=0; i < response.items.length; i++) {
                        // Create playlist button
                        var playlist = document.createElement("a");
                        playlist.classList.add("list-group-item", "list-group-item-action");
                        playlist.setAttribute("data-dismiss", "modal");
                        playlist.setAttribute("onclick", "getTracks('" + response.items[i].tracks.href + "')");
                        playlist.innerHTML = response.items[i].name;

                        // Append playlist button to list-group
                        listGroup.appendChild(playlist);
                    }

                    var nextLink = response.next;
                    while (nextLink !== null) {
                        $.ajax({
                            async: false,
                            url: nextLink,
                            headers: {
                                'Authorization': 'Bearer ' + access_token
                            },
                            success: function(response) {

                                // Add playlists to Playlist Modal
                                for (var i=0; i < response.items.length; i++) {
                                    // Create playlist button
                                    var playlist = document.createElement("a");
                                    playlist.classList.add("list-group-item", "list-group-item-action");
                                    playlist.setAttribute("data-dismiss", "modal");
                                    playlist.setAttribute("onclick", "getTracks('" + response.items[i].tracks.href + "')");
                                    playlist.innerHTML = response.items[i].name;

                                    // Append playlist button to list-group
                                    listGroup.appendChild(playlist);
                                }

                                nextLink = response.next;
                            }
                        });
                    }
                

                    // Add list-group to Playlist Modal
                    document.getElementById("playlist-table").appendChild(listGroup);

                    $('#login').hide();
                    $('#loggedin').show();
                }
            });
            
            $.ajax({
                url: 'https://api.spotify.com/v1/me/top/tracks',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                data: {
                    'limit': 50,
                    'time_range': 'long_term'
                },
                success: function(response) {
                    // topSongsLong = response.items;
                    
                    topSongsLong = {};
                    for (var i = 0; i < response.items.length; i++) {
                        topSongsLong[response.items[i].id] = i
                    }

                    $('#login').hide();
                    $('#loggedin').show();
                }
            });

            $.ajax({
                url: 'https://api.spotify.com/v1/me/top/tracks',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                data: {
                    'limit': 50,
                    'time_range': 'medium_term'
                },
                success: function(response) {
                    // topSongsMedium = response.items;
                    topSongsMedium = {};
                    for (var i = 0; i < response.items.length; i++) {
                        topSongsMedium[response.items[i].id] = i
                    }

                    $('#login').hide();
                    $('#loggedin').show();
                }
            });

            $.ajax({
                url: 'https://api.spotify.com/v1/me/top/tracks',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                data: {
                    'limit': 50,
                    'time_range': 'short_term'
                },
                success: function(response) {
                    // topSongsShort = response.items;

                    topSongsShort = {};
                    for (var i = 0; i < response.items.length; i++) {
                        topSongsShort[response.items[i].id] = i
                    }

                    $('#login').hide();
                    $('#loggedin').show();
                }
            });

            $.ajax({
                url: 'https://api.spotify.com/v1/me/top/artists',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                data: {
                    'limit': 50,
                    'time_range': 'long_term'
                },
                success: function(response) {
                    // topArtistsLong = response.items;

                    topArtistsLong = {};
                    for (var i = 0; i < response.items.length; i++) {
                        topArtistsLong[response.items[i].id] = i
                    }

                    $('#login').hide();
                    $('#loggedin').show();
                }
            });

            $.ajax({
                url: 'https://api.spotify.com/v1/me/top/artists',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                data: {
                    'limit': 50,
                    'time_range': 'medium_term'
                },
                success: function(response) {
                    // topArtistsMedium = response.items;

                    topArtistsMedium = {};
                    for (var i = 0; i < response.items.length; i++) {
                        topArtistsMedium[response.items[i].id] = i
                    }

                    $('#login').hide();
                    $('#loggedin').show();
                }
            });

            $.ajax({
                url: 'https://api.spotify.com/v1/me/top/artists',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                data: {
                    'limit': 50,
                    'time_range': 'short_term'
                },
                success: function(response) {
                    // topArtistsShort = response.items;

                    topArtistsShort = {};
                    for (var i = 0; i < response.items.length; i++) {
                        topArtistsShort[response.items[i].id] = i
                    }

                    $('#login').hide();
                    $('#loggedin').show();
                }
            });
            
        } else {
            // render initial screen
            $('#login').show();
            $('#loggedin').hide();
        }

        document.getElementById('obtain-new-token').addEventListener('click', function() {
            $.ajax({
            url: '/refresh_token',
            data: {
                'refresh_token': refresh_token
            }
            }).done(function(data) {
            access_token = data.access_token;
            oauthPlaceholder.innerHTML = oauthTemplate({
                access_token: access_token,
                refresh_token: refresh_token
            });
            });
        }, false);
        }
    })();

    Handlebars.registerHelper("inc", function(value, options) {
        return parseInt(value) + 1;
    });


    function printTracks(items) {
        var out = "";
        var coordinateData = [[], [], [], [], [], [], [], [], [], [], [], []]; // each genre gets data
        var songs = [[], [], [], [], [], [], [], [], [], [], [], []]; // each genre gets data
        var artists = [[], [], [], [], [], [], [], [], [], [], [], []]; // each genre gets data

        // Clear all entries in Track Info list
        document.getElementById('tracklist').innerHTML = "";

        for (var i=0, l=items.length; i<l; i++) {

            /**
            * Obtains parameters from the hash of the URL
            * @return Object
            */
            function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1);
                while ( e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            }

            var tracksSource = document.getElementById('tracks-template').innerHTML,
                tracksTemplate = Handlebars.compile(tracksSource),
                tracksPlaceholder = document.getElementById('tracks');   

            var params = getHashParams();

            var access_token = params.access_token,
                refresh_token = params.refresh_token,
                error = params.error;
            

            var danceability = 0;
            var energy = 0;
            var valence = 0;
            var trackElement = null;
            if (topTrackFlag) {
                trackElement = items[i];
            }
            else {
                trackElement = items[i].track;
            }
            var getTrackUrl = 'https://api.spotify.com/v1/audio-features/'+trackElement.id;

            if (error) {
                alert('There was an error during the authentication');
            } else {
                if (access_token) {

                    $.ajax({
                        async: false,
                        url: getTrackUrl,
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function(response) {
                            valence = response.valence;
                            energy = response.energy;
                            danceability = response.danceability;
                            // console.log(valence);
                            // console.log(energy);

                            $('#login').hide();
                            $('#loggedin').show();
                        }
                    });
                }
                else {
                    // render initial screen
                    $('#login').show();
                    $('#loggedin').hide();
                }
            }

            artistString = "";
            for (var j=0; j < trackElement.artists.length; j++) {
                if (j > 0) {
                    artistString = artistString + ", ";
                }
                artistString = artistString + trackElement.artists[j].name;
            }

            $.ajax({
                async: false,
                url: 'https://api.genius.com/search',
                data: {
                    'q': trackElement.name + " " + trackElement.artists[0].name,
                    'access_token': '6ZqeA_eFKZtfgcpwsD41GOZllZB-Fgx7KgxXMDWg08za5GdJHH_B2ureIyunRlCm'
                },
                success: function(response) {
                    song_info = null;
                    for (var j=0; j < response.response.hits.length; j++) {
                        if (response.response.hits[j].result.primary_artist.name.toLowerCase() === trackElement.artists[0].name.toLowerCase()) {
                            console.log("FOUND MATCH");
                            song_info = response.response.hits[j];
                            break;
                        }
                    }
                    if (song_info != null) {
                        song_api_path = song_info.result.api_path;
                        $.ajax({
                            async: false,
                            url: 'https://api.genius.com' + song_api_path,
                            data: {
                                'access_token': '6ZqeA_eFKZtfgcpwsD41GOZllZB-Fgx7KgxXMDWg08za5GdJHH_B2ureIyunRlCm'
                            },
                            success: function(response) {
                                var path = response.response.song.path;
                                console.log('https://genius.com' + path);
                                $.ajax({
                                    async: false,
                                    url: 'https://genius.com' + path,
                                    success: function(response) {
                                        var span = document.createElement('span');
                                        span.innerHTML = response;
                                        var x = span.getElementsByClassName("lyrics");
                                        var allWords = x[0].textContent || x[0].innerText;
                                        //console.log(allWords);

                                        allWords = allWords.replace(/\[.*?\]/gs, '');;
                                        var tokens = allWords.match(/\b(\w+)\b/g);
                                        //console.log(tokens);

                                        
                                        if (tokens !== null) {
                                            var happyWords = 0;
                                            var sadWords = 0;
                                            var numWords = tokens.length;
                                            for (var j = 0; j < tokens.length; j++) {
                                                if (tokens[j].toLowerCase() in words) {
                                                    if (words[tokens[j].toLowerCase()] < 0) {
                                                        sadWords += 1;
                                                    }
                                                    else {
                                                        happyWords += 1;
                                                    }
                                                }
                                            }

                                            var percentHappy = 0.5;
                                            if (happyWords !== 0 || sadWords !== 0) {
                                                percentHappy = happyWords / (happyWords + sadWords);
                                            }
                                            var percentEmotional = (happyWords + sadWords) / numWords;
                                            var lyricalDensity = 1000 * numWords / trackElement.duration_ms;
                                            console.log("percent happy: " + percentHappy);
                                            console.log("lyrical density: " + lyricalDensity);

                                            console.log(valence);
                                            valence = lyricalDensity * percentEmotional * percentHappy + (1 - lyricalDensity * percentEmotional) * valence;
                                            console.log(valence);
                                        }


                                        $('#login').hide();
                                        $('#loggedin').show();
                                    },
                                    error: function(response) {
                                        console.log(response);
                                    }
                                });

                                $('#login').hide();
                                $('#loggedin').show();
                            }
                        });
                    }

                    $('#login').hide();
                    $('#loggedin').show();
                }
            });

            // Create track entry
            var track = document.createElement("li");
            track.classList.add("list-group-item");

            // Create track title
            var trackTitle = document.createElement("h5");
            trackTitle.innerHTML = trackElement.name + " - " + artistString;
            track.appendChild(trackTitle);

            // Create row 1
            var row1 = document.createElement("div");
            row1.classList.add("row");

            // Create first column
            var col1 = document.createElement("div");
            col1.classList.add("col-sm-3");

            // Create valence title
            var valenceTitle = document.createElement("h6");
            valenceTitle.classList.add("progress-label");
            valenceTitle.innerHTML = "Valence";
            col1.appendChild(valenceTitle);
            row1.appendChild(col1);

            // Create second column
            var col2 = document.createElement("div");
            col2.classList.add("col-sm-9");

            // Create valence bar
            var bigValenceBar = document.createElement("div");
            bigValenceBar.classList.add("progress");
            var valenceBar = document.createElement("div");
            valenceBar.classList.add("progress-bar", "progress-bar-success");
            valenceBar.setAttribute("role", "progressbar");
            valenceBar.setAttribute("aria-valuenow", valence*100);
            valenceBar.setAttribute("aria-valuemin", "0");
            valenceBar.setAttribute("aria-valuemax", "100");
            valenceBar.setAttribute("style", "width: " + valence*100 + "%; color:black;")
            valenceBar.innerHTML = (valence*20 - 10).toFixed(2);
            bigValenceBar.appendChild(valenceBar);
            col2.appendChild(bigValenceBar);
            row1.appendChild(col2);
            track.append(row1);

            // Create row 2
            var row2 = document.createElement("div");
            row2.classList.add("row");

            // Create first column
            col1 = document.createElement("div");
            col1.classList.add("col-sm-3");

            // Create energy title
            var energyTitle = document.createElement("h6");
            energyTitle.classList.add("progress-label");
            energyTitle.innerHTML = "Energy";
            col1.appendChild(energyTitle);
            row2.appendChild(col1);

            // Create second column
            col2 = document.createElement("div");
            col2.classList.add("col-sm-9");

            // Create energy bar
            var bigEnergyBar = document.createElement("div");
            bigEnergyBar.classList.add("progress");
            var energyBar = document.createElement("div");
            energyBar.classList.add("progress-bar", "progress-bar-info");
            energyBar.setAttribute("role", "progressbar");
            energyBar.setAttribute("aria-valuenow", energy*100);
            energyBar.setAttribute("aria-valuemin", "0");
            energyBar.setAttribute("aria-valuemax", "100");
            energyBar.setAttribute("style", "width: " + energy*100 + "%; color:black;")
            energyBar.innerHTML = (energy*20 - 10).toFixed(2);
            bigEnergyBar.appendChild(energyBar);
            col2.appendChild(bigEnergyBar);
            row2.appendChild(col2);
            track.append(row2);

            // Append track entry to list
            document.getElementById('tracklist').appendChild(track);

            // Chart
            radiusSum = 5;
            radiusSum += trackRadiusSum(trackElement.id);
            
            for (var j = 0; j < trackElement.artists.length; j++) {
                radiusSum += artistRadiusSum(trackElement.artists[j].id);
            }

            // console.log(getArtistGenre(trackElement.artists));
            var trackGenre = getArtistGenre(trackElement.artists);

            coordinateData[genreStringArray.indexOf(trackGenre)].push({x: (valence*20 - 10).toFixed(2), y: (energy*20 - 10).toFixed(2), r: radiusSum});
            songs[genreStringArray.indexOf(trackGenre)].push(trackElement.name);
            artists[genreStringArray.indexOf(trackGenre)].push(artistString);
        }

        genreDatasets = []
        songDatasets = []
        artistDatasets = []
        // only display genres with at least one track
        for (var i = 0; i < coordinateData.length; i++) {
            if (coordinateData[i].length !== 0) {
                var dataset = {
                    label: genreLongStringArray[i],
                    backgroundColor: genreColorArray[i],
                    data: coordinateData[i]
                };
                genreDatasets.push(dataset);
                songDatasets.push(songs[i]);
                artistDatasets.push(artists[i]);
            }
        }

        bubbleChart.destroy();
        var ctx = document.getElementById("bubbleChart");
        bubbleChart = new Chart(ctx, {
            type: 'bubble',
            data: {
                songs: songDatasets,
                artists: artistDatasets,
                /*datasets: [{
                    label: "First dataset",
                    backgroundColor: 'rgba(54, 221, 166, 0.7)',
                    data: coordinateData
                }]*/
                datasets: genreDatasets
            },
            options: options
        });

        topTrackFlag = false;
        return out;
    }
    
    function trackRadiusSum(trackId) {
        var trackRadiusSum = 0;
        var rank = topSongsLong[trackId];
        if (rank !== undefined) {
            trackRadiusSum += 5 * (50 - rank)/50;
        }
        rank = topSongsMedium[trackId];
        if (rank !== undefined) {
            trackRadiusSum += 5 * (50 - rank)/50;
        }
        rank = topSongsShort[trackId];
        if (rank !== undefined) {
            trackRadiusSum += 5 * (50 - rank)/50;
        }
        return trackRadiusSum;
    }

    function artistRadiusSum(artistId) {
        var artistRadiusSum = 0;
        var rank = topArtistsLong[artistId];
        if (rank !== undefined) {
            artistRadiusSum += 2.5 * (50 - rank)/50;
        }
        rank = topArtistsMedium[artistId];
        if (rank !== undefined) {
            artistRadiusSum += 2.5 * (50 - rank)/50;
        }
        rank = topArtistsShort[artistId];
        if (rank !== undefined) {
            artistRadiusSum += 2.5 * (50 - rank)/50;
        }
        return artistRadiusSum;
    }

    function getArtistGenre(artistsArray) {
        var genreTallyArray = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

        // TAKE ALL ARTISTS OR SOME ARTISTS?
        //for (var i = 0; i < 1; i++) {
        for (var i = 0; i < artistsArray.length; i++) {
            /**
            * Obtains parameters from the hash of the URL
            * @return Object
            */
            function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1);
                while ( e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            }

            var params = getHashParams();

            var access_token = params.access_token,
                refresh_token = params.refresh_token,
                error = params.error;

            if (error) {
                alert('There was an error during the authentication');
            } else {
                if (access_token) {

                    $.ajax({
                        async: false,
                        url: 'https://api.spotify.com/v1/artists/' + artistsArray[i].id,
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function(response) {

                            for (var j = 0; j < response.genres.length; j++) {
                                var macroGenre = genres[response.genres[j]];
                                if (macroGenre !== undefined) {
                                    var index = genreStringArray.indexOf(macroGenre);
                                    if (index !== -1) {
                                        genreTallyArray[index] += 1;
                                    }
                                    else {
                                        // ERROR
                                        console.log("BAD FORMAT: " + response.genres[j]);
                                    }
                                }
                                else {
                                    // NON-EXISTENT GENRE
                                    console.log("DOESNT EXIST: " + response.genres[j]);
                                }
                            } 

                            $('#login').hide();
                            $('#loggedin').show();
                        }
                    });
                }
                else {
                    // render initial screen
                    $('#login').show();
                    $('#loggedin').hide();
                }
            }
        }

        // Get top genre
        var max = genreTallyArray[0];
        var maxIndex = 0;
        for (var i = 1; i < genreTallyArray.length; i++) {
            if (genreTallyArray[i] > max) {
                maxIndex = i;
                max = genreTallyArray[i];
            }
        }

        // Return top genre
        if (max == 0) {
            console.log("GENRE: UNKNOWN");
            return "u";
        }
        console.log("GENRE: " + genreStringArray[maxIndex]);
        return genreStringArray[maxIndex];
    }

    function getTracks(tracksUrl) {

        /**
        * Obtains parameters from the hash of the URL
        * @return Object
        */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while ( e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        var tracksSource = document.getElementById('tracks-template').innerHTML,
            tracksTemplate = Handlebars.compile(tracksSource),
            tracksPlaceholder = document.getElementById('tracks');   

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        if (error) {
            alert('There was an error during the authentication');
        } else {
            if (access_token) {

                $.ajax({
                    url: tracksUrl,
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    success: function(response) {

                        //tracksPlaceholder.innerHTML = tracksTemplate(response);
                        var allTracks = response.items;
                        var nextLink = response.next;
                        while (nextLink !== null) {
                            $.ajax({
                                async: false,
                                url: nextLink,
                                headers: {
                                    'Authorization': 'Bearer ' + access_token
                                },
                                success: function(response) {

                                    allTracks = allTracks.concat(response.items);
                                    nextLink = response.next;
                                    console.log(nextLink);
                                }
                            });
                        }
                        printTracks(allTracks);

                        $('#login').hide();
                        $('#loggedin').show();
                    }
                });
            }
            else {
                // render initial screen
                $('#login').show();
                $('#loggedin').hide();
            }
        }
    }


    function getRecentTracks() {

        /**
        * Obtains parameters from the hash of the URL
        * @return Object
        */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while ( e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        var tracksSource = document.getElementById('tracks-template').innerHTML,
            tracksTemplate = Handlebars.compile(tracksSource),
            tracksPlaceholder = document.getElementById('tracks');   

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        if (error) {
            alert('There was an error during the authentication');
        } else {
            if (access_token) {

                $.ajax({
                    url: "https://api.spotify.com/v1/me/player/recently-played",
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    data: {
                        'limit': 50
                    },
                    success: function(response) {
                        // tracksPlaceholder.innerHTML = tracksTemplate(response);
                        printTracks(response.items);

                        $('#login').hide();
                        $('#loggedin').show();
                    }
                });
            }
            else {
                // render initial screen
                $('#login').show();
                $('#loggedin').hide();
            }
        }
    }


    function getTopTracks(time_range) {

        /**
        * Obtains parameters from the hash of the URL
        * @return Object
        */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while ( e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        topTrackFlag = true;
        var tracksSource = document.getElementById('tracks-template').innerHTML,
            tracksTemplate = Handlebars.compile(tracksSource),
            tracksPlaceholder = document.getElementById('tracks');   

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        if (error) {
            alert('There was an error during the authentication');
        } else {
            if (access_token) {

                $.ajax({
                    url: 'https://api.spotify.com/v1/me/top/tracks',
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    data: {
                        'limit': 50,
                        'time_range': time_range
                    },
                    success: function(response) {
                        // tracksPlacetracksPlaceholder.innerHTML = tracksTemplate(response);
                        printTracks(response.items);

                        $('#login').hide();
                        $('#loggedin').show();
                    }
                });
            }
            else {
                // render initial screen
                $('#login').show();
                $('#loggedin').hide();
            }
        }
        
    }
    </script>

    <!-- jQuery -->
    <script src="../vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="../vendor/metisMenu/metisMenu.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="../dist/js/sb-admin-2.js"></script>

</body>

</html>
